<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Examseries | Exam Portal </title>

  <style>
    :root {
      --primary: #4a148c;
      --secondary: #7b1fa2;
      --accent: #e91e63;
      --light: #f3e5f5;
      --dark: #12005e;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --text: #333;
      --white: #fff;
      --gold: #ffd700;
      --silver: #c0c0c0;
      --bronze: #cd7f32;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
    body{background-color:var(--light);color:var(--text);line-height:1.6;}
    .container{max-width:1200px;margin:0 auto;padding:20px;}

    /* Login Page */
    .login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;background:linear-gradient(135deg,var(--primary),var(--secondary));}
    .login-box{background-color:var(--white);border-radius:10px;box-shadow:0 15px 30px rgba(0,0,0,.2);padding:40px;width:100%;max-width:450px;text-align:center;transform:translateY(0);transition:transform .3s ease;}
    .login-box:hover{transform:translateY(-5px);}
    .login-box h1{color:var(--primary);margin-bottom:30px;font-size:28px;font-weight:700;}
    .input-group{margin-bottom:20px;text-align:left;}
    .input-group label{display:block;margin-bottom:8px;color:var(--text);font-weight:600;}
    .input-group input{width:100%;padding:12px 15px;border:2px solid #ddd;border-radius:5px;font-size:16px;transition:border-color .3s;}
    .input-group input:focus{border-color:var(--primary);outline:none;}
    .login-btn{background-color:var(--primary);color:#fff;border:none;padding:12px 30px;border-radius:5px;cursor:pointer;font-size:16px;font-weight:600;width:100%;margin-top:10px;transition:background-color .3s;}
    .login-btn:hover{background-color:var(--secondary);}
    .admin-login{display:flex;align-items:center;justify-content:center;margin-top:25px;cursor:pointer;color:var(--primary);font-weight:600;}
    .admin-login i{margin-right:10px;font-size:20px;}
    .hidden{display:none !important;}

    /* Instruction */
    .instruction-container{max-width:800px;margin:40px auto;background-color:var(--white);border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.1);padding:30px;}
    .instruction-container h1{color:var(--primary);margin-bottom:20px;text-align:center;}
    .instruction-container h2{color:var(--secondary);margin:20px 0 15px;}
    .rules-list{margin-left:20px;}
    .rules-list li{margin-bottom:10px;}
    .start-btn{background-color:var(--primary);color:#fff;border:none;padding:12px 30px;border-radius:5px;cursor:pointer;font-size:16px;font-weight:600;display:block;margin:30px auto 0;transition:background-color .3s;}
    .start-btn:hover{background-color:var(--secondary);}

    /* Exam */
    .exam-container{max-width:800px;margin:20px auto;background-color:var(--white);border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.1);padding:30px;}
    .exam-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #eee;}
    .exam-title{color:var(--primary);font-size:24px;}
    .timer{background-color:var(--light);padding:8px 15px;border-radius:20px;font-weight:600;color:var(--primary);}
    .question-container{margin-bottom:30px;}
    .question-text{font-size:18px;font-weight:600;margin-bottom:15px;color:var(--dark);}
    .options{display:grid;grid-template-columns:1fr;gap:10px;}
    .option{padding:12px 15px;border:2px solid #ddd;border-radius:5px;cursor:pointer;transition:all .3s;}
    .option:hover{background-color:#f9f9f9;}
    .option.selected{background-color:var(--success);color:#fff;border-color:var(--success);}
    .exam-navigation{display:flex;justify-content:space-between;margin-top:30px;}
    .nav-btn{background-color:var(--primary);color:#fff;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-size:16px;font-weight:600;transition:background-color .3s;}
    .nav-btn:hover{background-color:var(--secondary);}
    .nav-btn:disabled{background-color:#ddd;cursor:not-allowed;}
    .submit-btn{background-color:var(--accent);color:#fff;border:none;padding:12px 30px;border-radius:5px;cursor:pointer;font-size:16px;font-weight:600;display:block;margin:30px auto 0;transition:background-color .3s;}
    .submit-btn:hover{background-color:#c2185b;}

    /* Name */
    .name-input-container{max-width:500px;margin:40px auto;background-color:var(--white);border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.1);padding:30px;text-align:center;}
    .name-input-container h1{color:var(--primary);margin-bottom:20px;}
    .name-input-container p{margin-bottom:20px;color:var(--text);}
    .name-input{width:100%;padding:12px 15px;border:2px solid #ddd;border-radius:5px;font-size:16px;margin-bottom:20px;}

    /* Results + Leaderboard */
    .results-container{max-width:1000px;margin:20px auto;background-color:var(--white);border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.1);padding:30px;}
    .results-header{text-align:center;margin-bottom:30px;}
    .results-header h1{color:var(--primary);margin-bottom:10px;}
    .user-name{font-size:24px;font-weight:600;color:var(--secondary);margin-bottom:5px;}
    .user-score{font-size:18px;color:var(--text);margin-bottom:20px;}
    .rank-badge{display:inline-block;background:linear-gradient(135deg,var(--gold),#ffec80);color:#856404;padding:8px 20px;border-radius:20px;font-weight:700;margin-bottom:20px;box-shadow:0 3px 10px rgba(0,0,0,.1);}
    .results-content{display:grid;grid-template-columns:1fr 1fr;gap:30px;}
    .performance-summary{background:linear-gradient(135deg,#f5f7fa,#e4e8f0);border-radius:10px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,.05);}
    .performance-summary h2{color:var(--primary);margin-bottom:20px;text-align:center;font-size:22px;}
    .performance-metrics{display:grid;grid-template-columns:1fr 1fr;gap:15px;}
    .metric-card{background-color:#fff;border-radius:8px;padding:15px;box-shadow:0 3px 10px rgba(0,0,0,.05);text-align:center;}
    .metric-value{font-size:28px;font-weight:700;margin-bottom:5px;}
    .metric-label{color:#666;font-size:14px;}
    .correct .metric-value{color:var(--success);}
    .incorrect .metric-value{color:var(--danger);}
    .unattempted .metric-value{color:var(--warning);}
    .score-card{grid-column:span 2;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:20px;border-radius:8px;text-align:center;}
    .score-label{font-size:16px;margin-bottom:10px;opacity:.9;}
    .total-score{font-size:36px;font-weight:700;margin-bottom:5px;}
    .max-score{font-size:16px;opacity:.8;}

    .questions-review{background-color:#fff;border-radius:10px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,.05);}
    .questions-review h2{color:var(--primary);margin-bottom:20px;font-size:22px;text-align:center;}
    .question-result{margin-bottom:20px;padding:15px;border-radius:5px;background-color:#f9f9f9;}
    .question-result.correct{border-left:4px solid var(--success);}
    .question-result.incorrect{border-left:4px solid var(--danger);}
    .question-result.unattempted{border-left:4px solid var(--warning);}
    .question-result-text{font-weight:600;margin-bottom:10px;}
    .option-review{display:flex;align-items:center;margin-bottom:5px;padding:8px;border-radius:4px;}
    .option-review.correct-answer{background-color:rgba(76,175,80,.1);border-left:3px solid var(--success);}
    .option-review.user-answer{background-color:rgba(33,150,243,.1);border-left:3px solid #2196f3;}
    .option-review.incorrect-answer{background-color:rgba(244,67,54,.1);border-left:3px solid var(--danger);}
    .option-marker{display:inline-block;width:20px;height:20px;border-radius:50%;margin-right:10px;text-align:center;font-weight:bold;font-size:12px;line-height:20px;}
    .correct-marker{background-color:var(--success);color:#fff;}
    .user-marker{background-color:#2196f3;color:#fff;}
    .incorrect-marker{background-color:var(--danger);color:#fff;}

    .leaderboard{grid-column:span 2;margin-top:30px;}
    .leaderboard h2{color:var(--primary);margin-bottom:20px;text-align:center;font-size:22px;}
    .leaderboard-table{width:100%;border-collapse:collapse;margin-top:15px;box-shadow:0 5px 15px rgba(0,0,0,.05);}
    .leaderboard-table th,.leaderboard-table td{padding:12px 15px;text-align:left;border-bottom:1px solid #eee;}
    .leaderboard-table th{background-color:var(--primary);color:#fff;font-weight:600;}
    .leaderboard-table tr:nth-child(even){background-color:#f9f9f9;}
    .leaderboard-table tr:hover{background-color:#f1f1f1;}
    .rank-cell{font-weight:700;text-align:center;}
    .rank-1{color:var(--gold);}
    .rank-2{color:var(--silver);}
    .rank-3{color:var(--bronze);}
    .highlight-user{background-color:rgba(74,20,140,.1) !important;font-weight:600;}

    .action-buttons{display:flex;justify-content:center;gap:15px;margin-top:30px;}
    .btn{padding:10px 20px;border-radius:5px;font-weight:600;cursor:pointer;transition:all .3s;border:none;display:flex;align-items:center;justify-content:center;}
    .btn i{margin-right:8px;}
    .btn-primary{background-color:var(--primary);color:#fff;}
    .btn-primary:hover{background-color:var(--secondary);}
    .btn-secondary{background-color:#f0f0f0;color:var(--text);}
    .btn-secondary:hover{background-color:#e0e0e0;}

    /* Admin Modal */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;visibility:hidden;transition:all .3s;}
    .modal-overlay.active{opacity:1;visibility:visible;}
    .modal{background-color:#fff;border-radius:10px;width:100%;max-width:500px;padding:30px;box-shadow:0 10px 25px rgba(0,0,0,.2);transform:translateY(-20px);transition:transform .3s;}
    .modal-overlay.active .modal{transform:translateY(0);}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
    .modal-header h2{color:var(--primary);}
    .close-modal{background:none;border:none;font-size:24px;cursor:pointer;color:#999;}

    /* Admin Panel */
    .admin-panel{max-width:1000px;margin:20px auto;background-color:var(--white);border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.1);padding:30px;}
    .admin-panel h1{color:var(--primary);margin-bottom:30px;text-align:center;}
    .admin-actions{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;}
    .admin-card{background-color:#f9f9f9;border-radius:8px;padding:20px;box-shadow:0 3px 10px rgba(0,0,0,.1);}
    .admin-card h3{color:var(--secondary);margin-bottom:15px;}
    .file-upload{margin-bottom:15px;}
    .file-upload label{display:block;margin-bottom:8px;font-weight:600;}
    .sample-download{margin-top:20px;}
    .sample-download a{color:var(--primary);text-decoration:none;font-weight:600;display:inline-flex;align-items:center;}
    .sample-download a i{margin-right:8px;}
    .questions-table{width:100%;border-collapse:collapse;margin-top:20px;}
    .questions-table th,.questions-table td{padding:12px 15px;text-align:left;border-bottom:1px solid #ddd;}
    .questions-table th{background-color:var(--light);color:var(--primary);font-weight:600;}

    /* Live Leaderboard Widget */
    .live-widget{position:fixed;right:15px;bottom:15px;background:#ffffff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.15);z-index:2000;width:300px;overflow:hidden;border:1px solid #eee;}
    .live-widget-header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:10px 14px;font-weight:700;display:flex;justify-content:space-between;align-items:center;}
    .live-widget-body{max-height:280px;overflow:auto;padding:10px;}
    .live-row{display:flex;justify-content:space-between;padding:8px 6px;border-bottom:1px solid #f0f0f0;}
    .live-row:nth-child(even){background:#fafafa;}
    .live-close{background:transparent;border:none;color:#fff;font-size:18px;cursor:pointer;}

    /* Notices */
    .notice{background:#fff3cd;border:1px solid #ffeeba;color:#856404;padding:12px 16px;border-radius:8px;margin-bottom:16px}
    .notice strong{font-weight:700}

    /* Responsive */
    @media (max-width: 768px){
      .login-box{padding:30px 20px;}
      .exam-container,.instruction-container,.results-container,.admin-panel{padding:20px;}
      .exam-header{flex-direction:column;align-items:flex-start;gap:10px;}
      .admin-actions{grid-template-columns:1fr;}
      .results-content{grid-template-columns:1fr;}
      .performance-metrics{grid-template-columns:1fr;}
      .score-card{grid-column:span 1;}
      .leaderboard{grid-column:span 1;}
      .live-widget{width:90%;right:5%;bottom:10px;}
    }
  </style>

  <!-- libs -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <!-- Login Page -->
  <div class="login-container" id="loginPage">
    <div class="login-box">
      <h1>Exam Portal Login</h1>
      <div class="input-group">
        <label for="username">Email</label>
        <input type="text" id="username" placeholder="Enter your email" autocomplete="off" />
      </div>
      <div class="input-group">
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Enter your password" autocomplete="new-password" />
      </div>
      <button class="login-btn" id="userLoginBtn">Login</button>
      <div class="admin-login" id="adminLoginBtn">
        <i class="fas fa-user-shield"></i>
        <span>Admin Login</span>
      </div>
    </div>
  </div>

  <!-- Admin Login Modal -->
  <div class="modal-overlay" id="adminModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Admin Login</h2>
        <button class="close-modal" id="closeModal">&times;</button>
      </div>
      <div class="input-group">
        <label for="adminUsername">Admin Email</label>
        <input type="text" id="adminUsername" placeholder="Enter admin email" autocomplete="off" />
      </div>
      <div class="input-group">
        <label for="adminPassword">Password</label>
        <input type="password" id="adminPassword" placeholder="Enter admin password" autocomplete="new-password" />
      </div>
      <button class="login-btn" id="adminLoginBtnModal">Login</button>
    </div>
  </div>

  <!-- Instruction Page -->
  <div class="instruction-container hidden" id="instructionPage">
    <h1>Exam Instructions</h1>
    <h2>Important Guidelines</h2>
    <ul class="rules-list">
      <li>This exam consists of multiple-choice questions.</li>
      <li>Each question carries <strong>1.25 marks</strong> for a correct answer.</li>
      <li>There is negative marking of <strong>-0.66 marks</strong> for each incorrect answer.</li>
      <li>Unattempted questions will not affect your score.</li>
      <li>The total duration for this exam is <strong>180 minutes</strong>.</li>
      <li>Click on an option to select your answer. Click again to deselect.</li>
      <li>You can change your answers anytime before submitting.</li>
      <li>Once submitted, you cannot modify your answers.</li>
    </ul>
    <button class="start-btn" id="startExamBtn">Start Exam</button>
  </div>

  <!-- Exam Page -->
  <div class="exam-container hidden" id="examPage">
    <div class="exam-header">
      <div class="exam-title">VDO Minor Test - 04 </div>
      <div class="timer" id="examTimer">180:00</div>
    </div>
    <div class="question-container" id="questionContainer"></div>
    <div class="exam-navigation">
      <button class="nav-btn" id="prevQuestionBtn" disabled><i class="fas fa-arrow-left"></i> Previous</button>
      <button class="nav-btn" id="nextQuestionBtn">Next <i class="fas fa-arrow-right"></i></button>
    </div>
    <button class="submit-btn" id="submitExamBtn"><i class="fas fa-paper-plane"></i> Submit Exam</button>
  </div>

  <!-- Name Input Page -->
  <div class="name-input-container hidden" id="nameInputPage">
    <h1>Almost Done!</h1>
    <p>Please enter your name as you want it to appear on the leadership board.</p>
    <input type="text" class="name-input" id="userNameInput" placeholder="Enter your full name" autocomplete="off" />
    <button class="login-btn" id="submitNameBtn">View Results</button>
  </div>

  <!-- Results / Leaderboard Page -->
  <div class="results-container hidden" id="resultsPage">
    <div id="attemptNotice" class="notice hidden"></div>

    <div class="results-header" id="resultsHeader">
      <h1>Exam Results</h1>
      <div class="user-name" id="resultUserName">John Doe</div>
      <div class="user-score" id="resultUserScore">Score: 15.34/20</div>
      <div class="rank-badge" id="resultRank">Rank: 1st</div>
    </div>

    <div class="results-content" id="resultsContent">
      <div class="performance-summary">
        <h2>Performance Summary</h2>
        <div class="performance-metrics">
          <div class="metric-card correct">
            <div class="metric-value" id="correctAnswersValue">7</div>
            <div class="metric-label">Correct Answers</div>
          </div>
          <div class="metric-card incorrect">
            <div class="metric-value" id="incorrectAnswersValue">1</div>
            <div class="metric-label">Incorrect Answers</div>
          </div>
          <div class="metric-card unattempted">
            <div class="metric-value" id="unattemptedQuestionsValue">2</div>
            <div class="metric-label">Unattempted</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="attemptedQuestionsValue">8</div>
            <div class="metric-label">Attempted</div>
          </div>
          <div class="score-card">
            <div class="score-label">Your Score</div>
            <div class="total-score" id="totalScoreValue">13.34</div>
            <div class="max-score" id="maxScoreValue">out of 20</div>
          </div>
        </div>
      </div>

      <div class="questions-review" id="questionsReview">
        <h2>Question Review</h2>
        <div id="questionsReviewContainer"></div>
      </div>

      <div class="leaderboard">
        <h2>Leadership Board (Live)</h2>
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>Rank</th><th>Name</th><th>Score</th><th>Correct</th><th>Incorrect</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </div>
    </div>

    <div class="action-buttons" id="resultsActions">
      <button class="btn btn-primary" id="downloadPdfBtn"><i class="fas fa-file-pdf"></i> Download PDF Report</button>
      <button class="btn btn-secondary" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </div>

  <!-- Admin Panel -->
  <div class="admin-panel hidden" id="adminPanel">
    <h1>Admin Dashboard</h1>
    <div class="admin-actions">
      <div class="admin-card">
        <h3>Upload Questions</h3>
        <div class="file-upload">
          <label for="excelUpload">Upload Excel File:</label>
          <input type="file" id="excelUpload" accept=".xlsx, .xls" />
        </div>
        <button class="btn btn-primary" id="uploadBtn"><i class="fas fa-upload"></i> Upload</button>
        <div class="sample-download">
          <a href="#" id="downloadSample"><i class="fas fa-file-excel"></i> Download Sample Excel</a>
        </div>
      </div>
      <div class="admin-card">
        <h3>Export Questions</h3>
        <button class="btn btn-primary" id="exportExcelBtn"><i class="fas fa-file-excel"></i> Export to Excel</button>
        <button class="btn btn-primary" id="exportJsonBtn" style="margin-top:10px;"><i class="fas fa-file-code"></i> Export to JSON</button>
      </div>
    </div>

    <h2>Current Questions</h2>
    <table class="questions-table">
      <thead>
        <tr>
          <th>ID</th><th>Question</th><th>Option A</th><th>Option B</th><th>Option C</th><th>Option D</th><th>Correct Answer</th>
        </tr>
      </thead>
      <tbody id="questionsTableBody"></tbody>
    </table>

    <div class="action-buttons" style="margin-top:30px;">
      <button class="btn btn-secondary" id="adminLogoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </div>

  <!-- Live Leaderboard Floating Widget -->
  <div class="live-widget hidden" id="liveWidget">
    <div class="live-widget-header">
      <span><i class="fas fa-bolt"></i> Live Top Scores</span>
      <button class="live-close" id="liveCloseBtn">&times;</button>
    </div>
    <div class="live-widget-body" id="liveWidgetBody">
      <!-- rows inject here -->
    </div>
  </div>

<!-- Firebase + App Logic -->
<script type="module">
  const examId = "vdotest04"; // इस फाइल के लिए
/* =======================
   FIREBASE SETUP
   ======================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, serverTimestamp, collection, addDoc, query, orderBy, limit, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

// TODO: Paste your Firebase config keys here (these are public in all web apps)
// Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCKsOYXQkC3h_XLU-1StZSefzWP4h0gvjg",
    authDomain: "loginattempt-71bb3.firebaseapp.com",
    projectId: "loginattempt-71bb3",
    storageBucket: "loginattempt-71bb3.firebasestorage.app",
    messagingSenderId: "116420300488",
    appId: "1:116420300488:web:3c34c5d42ce772638d9ffd"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* =======================
   DOM Elements
   ======================= */
const loginPage = document.getElementById('loginPage');
const instructionPage = document.getElementById('instructionPage');
const examPage = document.getElementById('examPage');
const nameInputPage = document.getElementById('nameInputPage');
const resultsPage = document.getElementById('resultsPage');
const adminModal = document.getElementById('adminModal');
const adminPanel = document.getElementById('adminPanel');

const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const userLoginBtn = document.getElementById('userLoginBtn');
const adminLoginBtn = document.getElementById('adminLoginBtn');
const closeModalBtn = document.getElementById('closeModal');
const adminLoginBtnModal = document.getElementById('adminLoginBtnModal');
const adminUsernameInput = document.getElementById('adminUsername');
const adminPasswordInput = document.getElementById('adminPassword');
const startExamBtn = document.getElementById('startExamBtn');
const submitExamBtn = document.getElementById('submitExamBtn');
const submitNameBtn = document.getElementById('submitNameBtn');
const userNameInput = document.getElementById('userNameInput');
const logoutBtn = document.getElementById('logoutBtn');
const downloadPdfBtn = document.getElementById('downloadPdfBtn');
const adminLogoutBtn = document.getElementById('adminLogoutBtn');
const liveWidget = document.getElementById('liveWidget');
const liveWidgetBody = document.getElementById('liveWidgetBody');
const liveCloseBtn = document.getElementById('liveCloseBtn');

const questionContainer = document.getElementById('questionContainer');
const prevQuestionBtn = document.getElementById('prevQuestionBtn');
const nextQuestionBtn = document.getElementById('nextQuestionBtn');
const questionsReviewContainer = document.getElementById('questionsReviewContainer');
const examTimer = document.getElementById('examTimer');
const questionsTableBody = document.getElementById('questionsTableBody');
const leaderboardBody = document.getElementById('leaderboardBody');

const resultsHeader = document.getElementById('resultsHeader');
const resultsActions = document.getElementById('resultsActions');
const attemptNotice = document.getElementById('attemptNotice');

const excelUpload = document.getElementById('excelUpload');
const uploadBtn = document.getElementById('uploadBtn');
const downloadSample = document.getElementById('downloadSample');
const exportExcelBtn = document.getElementById('exportExcelBtn');
const exportJsonBtn = document.getElementById('exportJsonBtn');

/* =======================
   Exam Data (will be loaded from Firebase)
   ======================= */
let examQuestions = [];
let userAnswers = [];
let timeLeft = 180*60;
let currentQuestionIndex = 0;

let lastResults = null;
let lastUserName = '';
let lastRankText = '';
let viewLeaderboardOnly = false;
let currentUser = null;
let leaderboardUnsub = null; // for live updates
let questionsUnsub = null; // for live question updates

/* =======================
   Event Listeners
   ======================= */
document.addEventListener('DOMContentLoaded', () => {
  userLoginBtn.addEventListener('click', handleUserLogin);
  adminLoginBtn.addEventListener('click', showAdminModal);
  closeModalBtn.addEventListener('click', hideAdminModal);
  adminLoginBtnModal.addEventListener('click', handleAdminLogin);

  startExamBtn.addEventListener('click', startExam);
  submitExamBtn.addEventListener('click', showNameInputPage);
  submitNameBtn.addEventListener('click', showResultsPage);
  prevQuestionBtn.addEventListener('click', showPreviousQuestion);
  nextQuestionBtn.addEventListener('click', showNextQuestion);
  logoutBtn.addEventListener('click', doLogout);
  adminLogoutBtn.addEventListener('click', doLogout);
  downloadPdfBtn.addEventListener('click', generatePdf);

  uploadBtn.addEventListener('click', handleExcelUpload);
  downloadSample.addEventListener('click', downloadSampleExcel);
  exportExcelBtn.addEventListener('click', exportToExcel);
  exportJsonBtn.addEventListener('click', exportToJson);

  liveCloseBtn.addEventListener('click', ()=> liveWidget.classList.add('hidden'));

  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    if (!user) {
      // force login screen
      unsubscribeLeaderboard();
      unsubscribeQuestions();
      hideAll();
      loginPage.classList.remove('hidden');
      return;
    }
  });
});

/* =======================
   LOGIN (Firebase) + Attempt Limit in Firestore
   ======================= */
async function handleUserLogin() {
  const email = usernameInput.value.trim();
  const pass = passwordInput.value.trim();
  if (!email || !pass) { alert('Enter email and password'); return; }

  try {
    const cred = await signInWithEmailAndPassword(auth, email, pass);
    currentUser = cred.user;

    // Load questions from Firebase
    await loadQuestionsFromFirebase();
    
    // Start live leaderboard subscription right after login
    subscribeLiveLeaderboard();

    // increment per-login attempt counter (users get only 3 full exam attempts; on 4th+ show results only)
    const aRef = doc(db, 'attempts', `${currentUser.uid}_${examId}`);
    const snap = await getDoc(aRef);
    if (!snap.exists()) {
      await setDoc(aRef, { count: 1, updatedAt: serverTimestamp() });
      showInstruction();
    } else {
      await updateDoc(aRef, { count: increment(1), updatedAt: serverTimestamp() });
      const newSnap = await getDoc(aRef);
      const c = newSnap.data().count || 0;
      if (c > 3) {
        await showReadOnlyResultsAndBoard();
      } else {
        showInstruction();
      }
    }
    passwordInput.value = '';
  } catch (e) {
    console.error(e);
    alert('Login failed. Check email/password or user not provisioned.');
  }
}

// Load questions from Firebase
async function loadQuestionsFromFirebase() {
  try {
    const questionsRef = doc(db, 'config', `questions_${examId}`);
const questionsSnap = await getDoc(questionsRef);
    
    if (questionsSnap.exists()) {
      examQuestions = questionsSnap.data().questions || [];
      userAnswers = Array(examQuestions.length).fill(null);
    } else {
      // If no questions exist in Firebase, use default questions
      examQuestions = getDefaultQuestions();
      userAnswers = Array(examQuestions.length).fill(null);
      await setDoc(questionsRef, { questions: examQuestions });
    }
  } catch (error) {
    console.error("Error loading questions from Firebase:", error);
    // Fallback to default questions
    examQuestions = getDefaultQuestions();
    userAnswers = Array(examQuestions.length).fill(null);
  }
}

// Subscribe to live question updates
function subscribeToQuestions() {
  unsubscribeQuestions();
  
  const questionsRef = doc(db, 'config', 'questions');
  questionsUnsub = onSnapshot(questionsRef, (doc) => {
    if (doc.exists()) {
      examQuestions = doc.data().questions || [];
      userAnswers = Array(examQuestions.length).fill(null);
      
      // Update UI if needed
      if (adminPanel && !adminPanel.classList.contains('hidden')) {
        renderQuestionsTable();
      }
    }
  }, (error) => {
    console.error("Error in questions subscription:", error);
  });
}

function unsubscribeQuestions() {
  if (typeof questionsUnsub === 'function') {
    try { questionsUnsub(); } catch(e){}
  }
  questionsUnsub = null;
}

// Default questions if none in Firebase
function getDefaultQuestions() {
  return [
    { id: 1, question: 'भारत की राजधानी कौन सी है?', options: ['कोलकाता','मुंबई','दिल्ली','चेन्नई'], correctAnswer: 2, explanation: 'भारत की राजधानी नई दिल्ली है।' },
    { id: 2, question: 'Which planet is known as the Red Planet?', options: ['Venus','Mars','Jupiter','Saturn'], correctAnswer: 1, explanation: 'Mars is often referred to as the Red Planet.' },
    { id: 3, question: 'CSS का पूरा नाम क्या है?', options: ['Creative Style Sheets','Cascading Style Sheets','Computer Style Sheets','Colorful Style Sheets'], correctAnswer: 1, explanation: 'CSS का अर्थ Cascading Style Sheets होता है।' },
    { id: 4, question: 'What does HTML stand for?', options: ['Hypertext Markup Language','Hypertext Markdown Language','Hyperloop Machine Language','None'], correctAnswer: 0, explanation: 'HTML stands for HyperText Markup Language.' },
    { id: 5, question: 'जावास्क्रिप्ट किस वर्ष लॉन्च हुई?', options: ['1996','1995','1994','1997'], correctAnswer: 1, explanation: 'JavaScript को 1995 में बनाया गया था।' },
    { id: 6, question: 'Which of these is not a JavaScript framework?', options: ['React','Angular','Vue','Django'], correctAnswer: 3, explanation: 'Django is a Python web framework.' },
    { id: 7, question: 'Which language runs in a web browser?', options: ['Java','C','Python','JavaScript'], correctAnswer: 3, explanation: 'JavaScript runs in web browsers.' },
    { id: 8, question: 'Which HTML attribute is used for inline styles?', options: ['class','font','style','styles'], correctAnswer: 2, explanation: "Use the 'style' attribute." },
    { id: 9, question: 'विश्व का सबसे बड़ा स्तनपायी कौन है?', options: ['हाथी','नीली व्हेल','जिराफ़','दरियाई घोड़ा'], correctAnswer: 1, explanation: 'नीली व्हेल सबसे बड़ा ज्ञात जीव है।' },
    { id:10, question: 'How do you create a function in JavaScript?', options: ['function = myFunction()','function:myFunction()','function myFunction()','create myFunction()'], correctAnswer: 2, explanation: "Correct syntax: function myFunction() {}" }
  ];
}

function showInstruction() {
  hideAll();
  instructionPage.classList.remove('hidden');
  liveWidget.classList.remove('hidden'); // show live widget during instructions
}

function showAdminModal(){ adminModal.classList.add('active'); }
function hideAdminModal(){ adminModal.classList.remove('active'); adminPasswordInput.value=''; }

async function handleAdminLogin() {
  const email = adminUsernameInput.value.trim();
  const pass = adminPasswordInput.value.trim();
  if (!email || !pass) { alert('Enter admin email/password'); return; }
  try {
    const cred = await signInWithEmailAndPassword(auth, email, pass);
    currentUser = cred.user;
    // verify admin by presence of doc admins/{uid}
    const adminRef = doc(db, 'admins', currentUser.uid);
    const s = await getDoc(adminRef);
    if (!s.exists()) {
      alert('You are not authorized as admin.');
      await signOut(auth);
      return;
    }
    adminModal.classList.remove('active');
    hideAll();
    adminPanel.classList.remove('hidden');
    renderQuestionsTable();
    subscribeLiveLeaderboard();
    subscribeToQuestions(); // Subscribe to question updates for admin
  } catch (e) {
    console.error(e);
    alert('Admin login failed.');
  }
}

/* =======================
   Exam Flow
   ======================= */
function startExam(){
  instructionPage.classList.add('hidden');
  examPage.classList.remove('hidden');
  liveWidget.classList.remove('hidden'); // keep live view visible
  currentQuestionIndex = 0;
  renderCurrentQuestion();
  startTimer();
}

function renderCurrentQuestion(){
  const q = examQuestions[currentQuestionIndex];
  questionContainer.innerHTML = `
    <div class="question-text">${q.id}. ${q.question}</div>
    <div class="options">
      ${q.options.map((opt, i)=>`
        <div class="option ${userAnswers[currentQuestionIndex]===i?'selected':''}" data-question="${currentQuestionIndex}" data-option="${i}">${opt}</div>
      `).join('')}
    </div>
  `;
  prevQuestionBtn.disabled = currentQuestionIndex===0;
  nextQuestionBtn.disabled = currentQuestionIndex===examQuestions.length-1;

  document.querySelectorAll('.option').forEach(opt=>{
    opt.addEventListener('click',function(){
      const qi = parseInt(this.dataset.question);
      const oi = parseInt(this.dataset.option);
      if (userAnswers[qi]===oi) {
        userAnswers[qi]=null; this.classList.remove('selected');
      } else {
        userAnswers[qi]=oi;
        this.parentElement.querySelectorAll('.option').forEach(el=>el.classList.remove('selected'));
        this.classList.add('selected');
      }
    });
  });
}

function showPreviousQuestion(){ if(currentQuestionIndex>0){ currentQuestionIndex--; renderCurrentQuestion(); } }
function showNextQuestion(){ if(currentQuestionIndex<examQuestions.length-1){ currentQuestionIndex++; renderCurrentQuestion(); } }

function startTimer(){
  const timerInterval = setInterval(()=>{
    timeLeft--;
    if(timeLeft<=0){
      clearInterval(timerInterval);
      examTimer.textContent = '00:00';
      submitExamBtn.click();
      return;
    }
    const m = Math.floor(timeLeft/60), s = timeLeft%60;
    examTimer.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  },1000);
}

function showNameInputPage(){
  const answered = userAnswers.filter(a=>a!==null).length;
  if (answered===0) {
    if (!confirm("You haven't answered any questions. Submit anyway?")) return;
  }
  examPage.classList.add('hidden');
  nameInputPage.classList.remove('hidden');
}

async function showResultsPage(){
  const name = userNameInput.value.trim();
  if(!name){ alert('Please enter your name'); return; }
  nameInputPage.classList.add('hidden');
  resultsPage.classList.remove('hidden');
  liveWidget.classList.remove('hidden'); // visible on results page too

  const results = calculateResults();
  await saveAttemptAndLeaderboard(name, results, userAnswers);
  await displayResults(name, results);
  // No manual renderLeaderboard call — it will update via live snapshot
}

function calculateResults(){
  const totalQuestions = examQuestions.length;
  const attempted = userAnswers.filter(a=>a!==null).length;
  const unattempted = totalQuestions - attempted;
  let correct=0, incorrect=0;
  examQuestions.forEach((q,i)=>{
    if(userAnswers[i]!==null){
      if(userAnswers[i]===q.correctAnswer) correct++; else incorrect++;
    }
  });
  const positiveMarks = correct * 1.25;
  const negativeMarks = incorrect * 0.66;
  const totalScore = positiveMarks - negativeMarks;
  return {
    totalQuestions, attempted, unattempted, correct, incorrect,
    positiveMarks: positiveMarks.toFixed(2),
    negativeMarks: negativeMarks.toFixed(2),
    totalScore: totalScore.toFixed(2),
    maxScore: (totalQuestions*1.25).toFixed(2),
    percentage: ((totalScore/(totalQuestions*1.25))*100).toFixed(2),
  };
}

/* =======================
   Firestore Persistence
   ======================= */
async function saveAttemptAndLeaderboard(name, results, answers){
  if (!currentUser) return;
  // save latest attempt
  const latestRef = doc(db, 'results', `${currentUser.uid}_${examId}`);
  await setDoc(latestRef, {
    name,
    results,
    answers,
    updatedAt: serverTimestamp()
  });

  // save attempts history (optional)
  const attemptsCol = collection(db, 'results', currentUser.uid, 'attempts');
  await addDoc(attemptsCol, {
    name, results, answers, createdAt: serverTimestamp()
  });

  // upsert leaderboard (best score)
  const lbRef = doc(db, 'leaderboard', `${currentUser.uid}_${examId}`);
  const s = await getDoc(lbRef);
  const scoreNum = parseFloat(results.totalScore);
  if (!s.exists() || (s.exists() && scoreNum > (s.data()?.score || 0))) {
    await setDoc(lbRef, {
      uid: currentUser.uid,
      name,
      score: scoreNum,
      correct: results.correct,
      incorrect: results.incorrect,
      updatedAt: serverTimestamp()
    });
  }
}

async function displayResults(userName, results){
  document.getElementById('resultUserName').textContent = userName;
  document.getElementById('resultUserScore').textContent = `Score: ${results.totalScore}/${results.maxScore}`;

  // rank derived from live leaderboard subscription; compute on the fly after snapshot renders
  document.getElementById('resultRank').textContent = `Rank: —`;

  document.getElementById('correctAnswersValue').textContent = results.correct;
  document.getElementById('incorrectAnswersValue').textContent = results.incorrect;
  document.getElementById('unattemptedQuestionsValue').textContent = results.unattempted;
  document.getElementById('attemptedQuestionsValue').textContent = results.attempted;
  document.getElementById('totalScoreValue').textContent = results.totalScore;
  document.getElementById('maxScoreValue').textContent = `out of ${results.maxScore}`;

  lastResults = results;
  lastUserName = userName;

  renderQuestionReviews();

  // visible blocks
  resultsHeader.classList.remove('hidden');
  document.getElementById('questionsReview').classList.remove('hidden');
  resultsActions.classList.remove('hidden');
  attemptNotice.classList.add('hidden');
  viewLeaderboardOnly = false;
}

function renderQuestionReviews(){
  const container = document.getElementById('questionsReviewContainer');
  container.innerHTML='';
  examQuestions.forEach((q,index)=>{
    const userAnswer = userAnswers[index];
    const isCorrect = userAnswer===q.correctAnswer;
    const isUnattempted = userAnswer===null;
    let statusClass='', statusText='';
    if(isUnattempted){ statusClass='unattempted'; statusText='Unattempted'; }
    else if(isCorrect){ statusClass='correct'; statusText='Correct'; }
    else{ statusClass='incorrect'; statusText='Incorrect'; }

    let optionsReview='';
    q.options.forEach((option,optIndex)=>{
      let optionClass='', markerClass='', markerText='';
      if(optIndex===q.correctAnswer){ optionClass='correct-answer'; markerClass='correct-marker'; markerText='✓'; }
      else if(optIndex===userAnswer){ optionClass='user-answer'; markerClass='user-marker'; markerText='Y'; }
      else if(userAnswer!==null && !isCorrect){ optionClass='incorrect-answer'; markerClass='incorrect-marker'; markerText='X'; }
      optionsReview += `<div class="option-review ${optionClass}"><span class="option-marker ${markerClass}">${markerText}</span>${option}</div>`;
    });

    const div=document.createElement('div');
    div.className=`question-result ${statusClass}`;
    div.innerHTML=`
      <div class="question-result-text">${q.id}. ${q.question} <strong>(${statusText})</strong></div>
      <div class="options-review">${optionsReview}</div>
      <div class="answer-explanation"><strong>Explanation:</strong> ${q.explanation || 'No explanation available.'}</div>`;
    container.appendChild(div);
  });
}

/* =======================
   LIVE LEADERBOARD (onSnapshot)
   ======================= */
function subscribeLiveLeaderboard(){
  unsubscribeLeaderboard();
  const qy = query(collection(db, 'leaderboard'), orderBy('score', 'desc'), limit(20));
  leaderboardUnsub = onSnapshot(qy, (ss) => {
    const rows = [];
    ss.forEach(d => {
      const v = d.data();
      rows.push({ uid: d.id, name: v.name || '—', score: v.score || 0, correct: v.correct || 0, incorrect: v.incorrect || 0 });
    });
    renderLeaderboardRows(rows);
    renderLiveWidget(rows.slice(0, 6)); // show top 6 in widget
    // update rank badge if on results page
    if (currentUser) {
      const rank = rows.findIndex(r => r.uid === currentUser.uid) + 1;
      if (rank > 0) {
        let rankText = rank===1 ? '1st 🏆' : rank===2 ? '2nd 🥈' : rank===3 ? '3rd 🥉' : `${rank}th`;
        const rankEl = document.getElementById('resultRank');
        if (rankEl) rankEl.textContent = `Rank: ${rankText}`;
      }
    }
  }, (err)=>{
    console.error('Live leaderboard error:', err);
  });
  liveWidget.classList.remove('hidden');
}

function unsubscribeLeaderboard(){
  if (typeof leaderboardUnsub === 'function') {
    try { leaderboardUnsub(); } catch(e){}
  }
  leaderboardUnsub = null;
}

function renderLeaderboardRows(rows){
  leaderboardBody.innerHTML='';
  rows.forEach((user,index)=>{
    const row=document.createElement('tr');
    const isCurrentUser = currentUser && user.uid === currentUser.uid;
    const rowClass = isCurrentUser?'highlight-user':'';
    let rankClass='';
    if(index===0) rankClass='rank-1';
    else if(index===1) rankClass='rank-2';
    else if(index===2) rankClass='rank-3';
    row.className=rowClass;
    row.innerHTML=`
      <td class="rank-cell ${rankClass}">${index+1}</td>
      <td>${user.name}</td>
      <td>${Number(user.score).toFixed(2)}</td>
      <td>${user.correct}</td>
      <td>${user.incorrect}</td>`;
    leaderboardBody.appendChild(row);
  });
}

function renderLiveWidget(rows){
  liveWidgetBody.innerHTML = rows.map((u,i)=>`
    <div class="live-row">
      <div>${i+1}. ${u.name}</div>
      <div>${Number(u.score).toFixed(2)}</div>
    </div>
  `).join('') || '<div class="live-row">No scores yet</div>';
}

/* =======================
   Leaderboard-only view after 3+ attempts
   Also show last saved result (read-only) + allow PDF/print/logout
   ======================= */
async function showReadOnlyResultsAndBoard(){
  hideAll();
  resultsPage.classList.remove('hidden');
  attemptNotice.classList.remove('hidden');
  attemptNotice.innerHTML = `<strong>Notice:</strong> You have reached the maximum of 3 attempts. You can view your last result, the Leadership Board (Live), and download/print.`;

  // Live widget visible
  liveWidget.classList.remove('hidden');
  subscribeLiveLeaderboard();

  // Load last result
  const latestRef = doc(db, 'results', auth.currentUser.uid);
  const s = await getDoc(latestRef);
  if (s.exists()) {
    const data = s.data();
    lastResults = data.results;
    lastUserName = data.name || 'User';
    document.getElementById('resultUserName').textContent = lastUserName;
    document.getElementById('resultUserScore').textContent = `Score: ${data.results.totalScore}/${data.results.maxScore}`;
    document.getElementById('correctAnswersValue').textContent = data.results.correct;
    document.getElementById('incorrectAnswersValue').textContent = data.results.incorrect;
    document.getElementById('unattemptedQuestionsValue').textContent = data.results.unattempted;
    document.getElementById('attemptedQuestionsValue').textContent = data.results.attempted;
    document.getElementById('totalScoreValue').textContent = data.results.totalScore;
    document.getElementById('maxScoreValue').textContent = `out of ${data.results.maxScore}`;

    // restore answers to render review/paper
    if (Array.isArray(data.answers)) {
      userAnswers = data.answers.slice();
    }
    renderQuestionReviews();
    // show header & review (read-only)
    resultsHeader.classList.remove('hidden');
    document.getElementById('questionsReview').classList.remove('hidden');
  } else {
    // no past result
    resultsHeader.classList.add('hidden');
    document.getElementById('questionsReview').classList.add('hidden');
  }

  resultsActions.classList.remove('hidden');
  viewLeaderboardOnly = true;
}

/* =======================
   Admin Panel (same UI; no hardcoded creds)
   ======================= */
function renderQuestionsTable(){
  questionsTableBody.innerHTML='';
  examQuestions.forEach((q)=>{
    const row=document.createElement('tr');
    row.innerHTML=`
      <td>${q.id}</td>
      <td>${q.question}</td>
      <td>${q.options[0]}</td>
      <td>${q.options[1]}</td>
      <td>${q.options[2]}</td>
      <td>${q.options[3]}</td>
      <td>${String.fromCharCode(65 + q.correctAnswer)} (${q.options[q.correctAnswer]})</td>`;
    questionsTableBody.appendChild(row);
  });
}

function handleExcelUpload(){
  const file=excelUpload.files[0];
  if(!file){ alert('Please select an Excel file first'); return; }
  const reader=new FileReader();
  reader.onload=function(e){
    const data=new Uint8Array(e.target.result);
    const wb=XLSX.read(data,{type:'array'});
    const sheet=wb.Sheets[wb.SheetNames[0]];
    const json=XLSX.utils.sheet_to_json(sheet);
    processUploadedQuestions(json);
  };
  reader.readAsArrayBuffer(file);
}

async function processUploadedQuestions(data){
  try{
    const newQ=[]; let id=1;
    data.forEach(row=>{
      if(!row.Question || !row['Option A'] || !row['Option B'] || !row['Option C'] || !row['Option D'] || !row.Answer) return;
      let correctAnswer;
      if(row.Answer.toUpperCase()==='A') correctAnswer=0;
      else if(row.Answer.toUpperCase()==='B') correctAnswer=1;
      else if(row.Answer.toUpperCase()==='C') correctAnswer=2;
      else if(row.Answer.toUpperCase()==='D') correctAnswer=3;
      else{
        const opts=[row['Option A'],row['Option B'],row['Option C'],row['Option D']];
        correctAnswer = opts.findIndex(opt=>opt===row.Answer);
        if(correctAnswer===-1) correctAnswer=0;
      }
      newQ.push({ id:id++, question: row.Question, options:[row['Option A'],row['Option B'],row['Option C'],row['Option D']], correctAnswer, explanation: row.Explanation || '' });
    });
    if(newQ.length>0){ 
      // Save to Firebase so all devices get the updated questions
      const questionsRef = doc(db, 'config', `questions_${examId}`);
await setDoc(questionsRef, { questions: newQ });
      
      examQuestions = newQ; 
      renderQuestionsTable(); 
      alert(`Successfully uploaded ${newQ.length} questions! These will now be available to all users.`); 
    }
    else alert('No valid questions found in the uploaded file');
  }catch(err){
    console.error('Error processing uploaded file:',err);
    alert('Error processing uploaded file. Please check the format and try again.');
  }
}

function downloadSampleExcel(){
  const sampleData=[
    { Question:'भारत की राजधानी कौन सी है?', 'Option A':'कोलकाता','Option B':'मुंबई','Option C':'दिल्ली','Option D':'चेन्नई', Answer:'C', Explanation:'भारत की राजधानी नई दिल्ली है।' },
    { Question:'Which planet is known as the Red Planet?', 'Option A':'Venus','Option B':'Mars','Option C':'Jupiter','Option D':'Saturn', Answer:'B', Explanation:'Mars is often referred to as the Red Planet.' }
  ];
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.json_to_sheet(sampleData);
  XLSX.utils.book_append_sheet(wb,ws,'Questions');
  XLSX.writeFile(wb,'Sample_Questions.xlsx');
}

function exportToExcel(){
  const exportData=examQuestions.map(q=>({
    Question:q.question,'Option A':q.options[0],'Option B':q.options[1],'Option C':q.options[2],'Option D':q.options[3],
    Answer:String.fromCharCode(65+q.correctAnswer), Explanation:q.explanation||'',
  }));
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.json_to_sheet(exportData);
  XLSX.utils.book_append_sheet(wb,ws,'Questions');
  XLSX.writeFile(wb,'Exam_Questions.xlsx');
}

function exportToJson(){
  const exportData=examQuestions.map(q=>({ id:q.id, question:q.question, options:q.options, correctAnswer:String.fromCharCode(65+q.correctAnswer), explanation:q.explanation||'' }));
  const jsonStr=JSON.stringify(exportData,null,2);
  const blob=new Blob([jsonStr],{type:'application/json'});
  saveAs(blob,'Exam_Questions.json');
}

/* =======================
   PDF Generation
   ======================= */
async function generatePdf() {
  try {
    if (!lastResults) {
      alert('Please view your results first.');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pdfWidth = doc.internal.pageSize.getWidth();
    const pdfHeight = doc.internal.pageSize.getHeight();
    const margin = 10;

    const actionsEl = document.getElementById('resultsActions');
    const wasHidden = actionsEl.classList.contains('hidden');
    actionsEl.classList.add('hidden');

    async function captureFixed(el) {
      const clone = el.cloneNode(true);
      const wrapper = document.createElement('div');
      wrapper.style.width = '794px';
      wrapper.style.background = '#fff';
      wrapper.style.padding = '10px';
      wrapper.style.boxSizing = 'border-box';
      wrapper.appendChild(clone);
      wrapper.querySelectorAll('button, input, .btn').forEach(x=>x.remove());
      document.body.appendChild(wrapper);
      const canvas = await html2canvas(wrapper, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
      document.body.removeChild(wrapper);
      return canvas;
    }

    const headerBlock = document.createElement('div');
    headerBlock.appendChild(document.getElementById('resultsHeader').cloneNode(true));
    headerBlock.appendChild(document.querySelector('.performance-summary').cloneNode(true));
    headerBlock.appendChild(document.querySelector('.leaderboard').cloneNode(true));

    const headerCanvas = await captureFixed(headerBlock);
    const headerImg = headerCanvas.toDataURL('image/png');
    const headerImgW = pdfWidth - margin*2;
    const headerImgH = (headerCanvas.height * headerImgW) / headerCanvas.width;

    let remainingHeaderHeight = headerImgH;
    let offsetY = 0;
    doc.addImage(headerImg, 'PNG', margin, margin, headerImgW, headerImgH);
    remainingHeaderHeight -= (pdfHeight - margin*2);
    offsetY += (pdfHeight - margin*2);

    while (remainingHeaderHeight > 0) {
      doc.addPage();
      doc.addImage(headerImg, 'PNG', margin, margin - offsetY, headerImgW, headerImgH);
      offsetY += (pdfHeight - margin*2);
      remainingHeaderHeight -= (pdfHeight - margin*2);
    }

    const questionsCanvas = await captureFixed(document.getElementById('questionsReview'));
    const questionsImg = questionsCanvas.toDataURL('image/png');
    const qImgW = pdfWidth - margin*2;
    const qImgH = (questionsCanvas.height * qImgW) / questionsCanvas.width;

    doc.addPage();
    doc.addImage(questionsImg, 'PNG', margin, margin, qImgW, qImgH);

    let remainingQ = qImgH - (pdfHeight - margin*2);
    let qOffset = (pdfHeight - margin*2);
    while (remainingQ > 0) {
      doc.addPage();
      doc.addImage(questionsImg, 'PNG', margin, margin - qOffset, qImgW, qImgH);
      qOffset += (pdfHeight - margin*2);
      remainingQ -= (pdfHeight - margin*2);
    }

    doc.save('exam_results.pdf');

    if (!wasHidden) actionsEl.classList.remove('hidden');
  } catch (err) {
    console.error('Error generating PDF:', err);
    alert('Error generating PDF. Please try again or check console for details.');
  }
}

/* =======================
   Logout and Helpers
   ======================= */
async function doLogout(){
  try { await signOut(auth); } catch(e){}
  resetState();
  unsubscribeLeaderboard();
  unsubscribeQuestions();
  hideAll();
  loginPage.classList.remove('hidden');
  liveWidget.classList.add('hidden');
}

function resetState(){
  userAnswers = Array(examQuestions.length).fill(null);
  timeLeft = 20*60;
  currentQuestionIndex = 0;
  usernameInput.value=''; passwordInput.value='';
  userNameInput.value=''; adminUsernameInput.value=''; adminPasswordInput.value='';
  lastResults=null; lastUserName=''; lastRankText='';
  viewLeaderboardOnly=false;
}

function hideAll(){
  [resultsPage, adminPanel, instructionPage, examPage, nameInputPage, loginPage].forEach(el=>el.classList.add('hidden'));
}
</script>
</body>


</html>

